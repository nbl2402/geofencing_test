name: Android Tests CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  android-tests-update:
    runs-on: ubuntu-latest

#    env:
#      ANDROID_HOME: ${{ github.workspace }}/android-sdk
#      ANDROID_SDK_ROOT: ${{ github.workspace }}/android-sdk
#      ANDROID_AVD_HOME: ${{ github.workspace }}/.android/avd

    steps:
      # Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3

      #          sudo rm -rf /usr/local/lib/android
      # Free disk space
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          df -h

      # Install system dependencies
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y tar wget unzip qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils openjdk-17-jdk

      # Setup Java 17
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

#      # Download Android SDK Command Line Tools
#      - name: Download Android SDK Command Line Tools
#        run: |
#          mkdir -p $ANDROID_HOME/cmdline-tools
#          cd $ANDROID_HOME/cmdline-tools
#          wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
#          unzip cmdline-tools.zip
#          mv cmdline-tools latest
#          rm cmdline-tools.zip
#
#      - name: Set Android SDK PATH
#        run: |
#          echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH
#          echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH
#          echo "$ANDROID_HOME/emulator" >> $GITHUB_PATH
#
#      # Accept SDK licenses
#      - name: Accept Android licenses
#        run: yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
#
#      # Install Android SDK packages (ARM64 â€“ no KVM)
#      - name: Install Android SDK packages
#        run: |
#          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
#            "platform-tools" \
#            "platforms;android-33" \
#            "emulator" \
#            "system-images;android-33;google_apis;arm64-v8a"
#
#      # Verify Android SDK
#      - name: Verify Android SDK
#        run: |
#          echo "ANDROID_HOME=$ANDROID_HOME"
#          ls -la $ANDROID_HOME
#          $ANDROID_HOME/platform-tools/adb version
#          $ANDROID_HOME/emulator/emulator -version
#
#      # Create ARM64 AVD
#      - name: Create ARM64 AVD
#        run: |
#          echo "no" | $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager \
#            create avd -n test-arm64 \
#            -k "system-images;android-33;google_apis;arm64-v8a" \
#            --force

      - name: Run Android emulator & tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 33
          target: google_apis
          arch: x86_64-v8a
          profile: pixel_5
          emulator-options: >
            -no-window
            -no-audio
            -no-boot-anim
            -gpu swiftshader_indirect
            -no-snapshot
            -no-metrics
          script: |
            echo "ADB location:"
            which adb
            adb wait-for-device
            adb devices
            mvn clean test

