name: Android Appium Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  AVD_NAME: test
  ANDROID_API_LEVEL: 33
  SYSTEM_IMAGE: "system-images;android-33;google_apis;x86_64"
  EMULATOR_RAM: 2048

jobs:
  appium-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # Install dependencies
      - name: Install required packages
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip openjdk-11-jdk qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils
          sudo apt-get install -y libncurses5 libstdc++6 lib32z1 libbz2-1.0 libgl1-mesa-dev
        shell: bash

      # Setup Android SDK
      - name: Setup Android SDK
        run: |
          mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
          cd $ANDROID_SDK_ROOT/cmdline-tools
          wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
          unzip cmdline-tools.zip
          mv cmdline-tools latest
          rm cmdline-tools.zip
          yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses
          $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "platform-tools" "platforms;android-$ANDROID_API_LEVEL" "$SYSTEM_IMAGE"
        shell: bash

      # Add Android tools to PATH
      - name: Add Android SDK to PATH
        run: |
          echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH

      # Create and start emulator
      - name: Create AVD
        run: |
          echo "no" | avdmanager create avd -n $AVD_NAME -k "$SYSTEM_IMAGE" --force
      - name: Start Emulator
        run: |
          $ANDROID_SDK_ROOT/emulator/emulator -avd $AVD_NAME -no-audio -no-window -gpu swiftshader_indirect -memory $EMULATOR_RAM &
          adb wait-for-device
          adb shell input keyevent 82
        shell: bash

      # Run Appium tests
      - name: Run Appium tests
        run: |
          # Start Appium server
          npx appium &
          sleep 10
          # Run your test script
          mvn test
        shell: bash
