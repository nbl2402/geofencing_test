name: Android Appium CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  android-emulator-test:
    runs-on: ubuntu-latest
    env:
      ANDROID_HOME: ${{ runner.workspace }}/android-sdk
      ANDROID_AVD_HOME: ${{ runner.workspace }}/.android/avd
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
      PATH: ${{ runner.workspace }}/android-sdk/cmdline-tools/latest/bin:$ANDROID_HOME/emulator:$ANDROID_HOME/platform-tools:$PATH
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip tar libncurses5 libstdc++6 libgtk-3-0 libpulse0 libnss3 libx11-xcb1 libxcb1 libxrandr2 libxss1 libglu1-mesa xvfb
          java -version

      - name: Setup Android SDK
        run: |
          mkdir -p $ANDROID_HOME/cmdline-tools
          cd $ANDROID_HOME/cmdline-tools
          # Download cmdline-tools if not exists
          if [ ! -f commandlinetools-linux-9477386_latest.zip ]; then
            wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          fi
          unzip -q commandlinetools-linux-9477386_latest.zip -d tmp
          mkdir -p latest
          mv tmp/cmdline-tools/* latest/
          rm -rf tmp
          yes | sdkmanager --licenses
          sdkmanager --install "platform-tools" "emulator" "platforms;android-33" "build-tools;33.0.2" "system-images;android-33;google_apis;x86_64"

      - name: Create Android Emulator
        run: |
          mkdir -p $ANDROID_AVD_HOME
          echo "no" | avdmanager create avd -n test -k "system-images;android-33;google_apis;x86_64" --force

      - name: Start Emulator
        run: |
          nohup $ANDROID_HOME/emulator/emulator -avd test -no-window -no-audio -no-boot-anim -gpu swiftshader_indirect &
          $ANDROID_HOME/platform-tools/adb wait-for-device
          $ANDROID_HOME/platform-tools/adb shell input keyevent 82
          echo "Emulator started"

      - name: Run Appium Tests
        run: |
          # Start Appium server
          npm install -g appium
          appium & 
          sleep 10
          # Run your test script
          ./gradlew connectedAndroidTest  # Hoặc command chạy test Java/Appium của bạn
